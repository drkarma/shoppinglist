name: Notify on push (Discord)

on:
  push:
    branches: [ master ]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build and send report to Discord
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_MENTION: ${{ secrets.DISCORD_MENTION }} # optional: <@userId> or <@&roleId>
        with:
          script: |
            const core = require('@actions/core');

            const webhook = process.env.DISCORD_WEBHOOK_URL;
            if (!webhook) {
              core.setFailed('Missing secret DISCORD_WEBHOOK_URL');
              return;
            }

            const mention = process.env.DISCORD_MENTION || '';
            const owner   = context.repo.owner;
            const repo    = context.repo.repo;
            const branch  = context.ref.replace('refs/heads/','');
            const before  = context.payload.before;
            const after   = context.sha;

            // Första pushen (before = zero SHA): jämför mot parent om möjligt
            const zero = '0000000000000000000000000000000000000000';
            let base = before;
            if (before === zero) {
              try {
                const {data: commit} = await github.rest.repos.getCommit({owner, repo, ref: after});
                base = (commit.parents && commit.parents[0]) ? commit.parents[0].sha : after;
              } catch {
                base = after;
              }
            }

            // Hämta compare-data via GitHub API
            const cmp = await github.rest.repos.compareCommits({owner, repo, base, head: after});

            // Commits (latest → oldest)
            const commits = (cmp.data.commits || [])
              .reverse()
              .map(c => `- ${c.sha.slice(0,7)} — ${c.commit.message.split('\n')[0]}`)
              .join('\n') || '- (none)';

            // Filer grupperade
            const files = cmp.data.files || [];
            const listBy = (status) => {
              const arr = files.filter(f => f.status === status).map(f => `- ${f.filename}`);
              return arr.length ? arr.join('\n') : '- (none)';
            };
            const added    = listBy('added');
            const modified = listBy('modified');
            const deleted  = listBy('removed');

            const compareUrl = `https://github.com/${owner}/${repo}/compare/${base}...${after}`;

            // Bygg Discord-innehåll rad för rad (robust mot YAML)
            const lines = [
              mention ? `${mention}` : '',
              `*Repo:* ${owner}/${repo}`,
              `*Branch:* ${branch}`,
              ``,
              `*Commits (latest → oldest):*`,
              commits,
              ``,
              `*Files changed:*`,
              `• *Added:*`,
              added,
              `• *Modified:*`,
              modified,
              `• *Deleted:*`,
              deleted,
              ``,
              `*Compare:* ${compareUrl}`
            ].filter(Boolean);
            let content = lines.join('\n');

            // Discord content limit ~2000 chars
            if (content.length > 1800) {
              content = content.slice(0, 1750) + '\n\n_(truncated)_\n' + compareUrl;
            }

            const res = await fetch(webhook, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ username: 'Shopylist CI', content })
            });
            if (!res.ok) {
              const msg = await res.text();
              core.setFailed(`Discord webhook failed: ${res.status} ${res.statusText} – ${msg}`);
            }
