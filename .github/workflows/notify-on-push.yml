name: Notify on push (Discord)

on:
  push:
    branches: [ master ]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build and send report to Discord
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_MENTION: ${{ secrets.DISCORD_MENTION }} # optional: <@userId> or <@&roleId>
        with:
          script: |
            const core = require('@actions/core');
            const webhook = process.env.DISCORD_WEBHOOK_URL;
            if (!webhook) {
              core.setFailed('Missing secret DISCORD_WEBHOOK_URL');
              return;
            }
            const mention = process.env.DISCORD_MENTION || '';
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const branch = context.ref.replace('refs/heads/','');
            const before = context.payload.before;
            const after  = context.sha;

            // First push (before == zero SHA) -> compare against parent of after if possible
            const zero = '0000000000000000000000000000000000000000';
            let base = before;
            if (before === zero) {
              try {
                const {data: commit} = await github.rest.repos.getCommit({owner, repo, ref: after});
                if (commit.parents && commit.parents[0]) base = commit.parents[0].sha;
                else base = after;
              } catch { base = after; }
            }

            // Compare via GitHub API
            const cmp = await github.rest.repos.compareCommits({owner, repo, base, head: after});

            // Commits (latest → oldest)
            const commits = (cmp.data.commits || [])
              .reverse()
              .map(c => `- ${c.sha.slice(0,7)} — ${c.commit.message.split('\\n')[0]}`)
              .join('\\n') || '- (none)';

            // Files grouped
            const files = cmp.data.files || [];
            const group = (status) => {
              const map = {added:'added', modified:'modified', removed:'removed', renamed:'renamed'};
              const arr = files.filter(f => f.status === map[status]).map(f => `- ${f.filename}`);
              return arr.length ? arr.join('\\n') : '- (none)';
            };
            const added    = group('added');
            const modified = group('modified');
            const deleted  = group('removed');

            const compareUrl = `https://github.com/${owner}/${repo}/compare/${base}...${after}`;

            let content = `${mention}
*Repo:* ${owner}/${repo}
*Branch:* ${branch}

*Commits (latest → oldest):*
${commits}

*Files changed:*
• *Added:*
${added}
• *Modified:*
${modified}
• *Deleted:*
${deleted}

*Compare:* ${compareUrl}
`;

            // Discord content limit ~2000 chars
            if (content.length > 1800) {
              content = content.slice(0, 1750) + '\\n\\n_(truncated)_\\n' + compareUrl;
            }

            const res = await fetch(webhook, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ username: 'Shopylist CI', content })
            });
            if (!res.ok) {
              const msg = await res.text();
              core.setFailed(`Discord webhook failed: ${res.status} ${res.statusText} – ${msg}`);
            }
